name: CI/CD — Build, Test & Deploy

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build backend & frontend, then deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      ##############################
      # Backend
      ##############################

      - name: Cache backend node_modules
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: backend-node-modules-${{ runner.os }}-$(hashFiles('backend/package-lock.json'))
          restore-keys: |
            backend-node-modules-${{ runner.os }}-

      - name: Backend — install dependencies
        working-directory: backend
        run: npm ci

      - name: Backend — run tests if configured
        working-directory: backend
        run: |
          # run tests only if package.json defines a non-placeholder test script
          node -e "const p=require('./package.json'); const t=p.scripts && p.scripts.test; if(t && !t.includes('Error: no test specified')) process.exit(0); process.exit(1);" && npm test || echo 'Skipping backend tests (none configured)'

      ##############################
      # Frontend
      ##############################

      - name: Cache frontend node_modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: frontend-node-modules-${{ runner.os }}-$(hashFiles('frontend/package-lock.json'))
          restore-keys: |
            frontend-node-modules-${{ runner.os }}-

      - name: Frontend — install dependencies
        working-directory: frontend
        run: npm ci

      - name: Frontend — run tests (if present)
        working-directory: frontend
        env:
          CI: true
        run: npm test --if-present

      - name: Frontend — build
        working-directory: frontend
        run: npm run build

      ##############################
      # Deploy backend to Render (trigger + poll)
      ##############################

      - name: Deploy backend to Render (trigger + poll)
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID_BACKEND }}
        run: |
          set -euo pipefail
          if [ -z "${RENDER_API_KEY:-}" ] || [ -z "${RENDER_SERVICE_ID:-}" ]; then
            echo "Missing Render secrets for backend (RENDER_API_KEY or RENDER_SERVICE_ID_BACKEND)"
            exit 1
          fi
          echo "Triggering backend deploy for service $RENDER_SERVICE_ID"
          DEPLOY_JSON=$(curl -s -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache":true}')
          echo "$DEPLOY_JSON"
          DEPLOY_ID=$(echo "$DEPLOY_JSON" | node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync(0,'utf8')); console.log(j.id||'')")
          if [ -z "$DEPLOY_ID" ]; then
            echo "Backend deploy start failed: no deploy id returned"
            exit 1
          fi
          echo "Backend deploy id: $DEPLOY_ID"
          # Poll for status (max 30 attempts, 10s interval => ~5 minutes)
          for attempt in $(seq 1 30); do
            STATUS_JSON=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$DEPLOY_ID")
            echo "$STATUS_JSON" > /tmp/backend_deploy_status.json
            STATUS=$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync('/tmp/backend_deploy_status.json','utf8')); console.log((j.status||j.state||'').toLowerCase())")
            echo "Backend deploy status: $STATUS"
            if echo "$STATUS" | grep -iq "fail\|error\|cancel"; then
              echo "Backend deploy failed: $STATUS"
              cat /tmp/backend_deploy_status.json
              exit 1
            fi
            if echo "$STATUS" | grep -Eiq "(succe|success|succeeded|live|active|ready|deployed|finished)"; then
              echo "Backend deploy succeeded: $STATUS"
              break
            fi
            echo "Waiting 10s for backend deploy to progress (attempt $attempt)..."
            sleep 10
          done
          if [ "$attempt" -eq 30 ]; then
            echo "Backend deploy timed out"
            exit 1
          fi

      ##############################
      # Deploy frontend to Render (trigger + poll)
      ##############################

      - name: Deploy frontend to Render (trigger + poll)
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID_FRONTEND }}
        run: |
          set -euo pipefail
          if [ -z "${RENDER_API_KEY:-}" ] || [ -z "${RENDER_SERVICE_ID:-}" ]; then
            echo "Missing Render secrets for frontend (RENDER_API_KEY or RENDER_SERVICE_ID_FRONTEND)"
            exit 1
          fi
          echo "Triggering frontend deploy for service $RENDER_SERVICE_ID"
          DEPLOY_JSON=$(curl -s -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache":true}')
          echo "$DEPLOY_JSON"
          DEPLOY_ID=$(echo "$DEPLOY_JSON" | node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync(0,'utf8')); console.log(j.id||'')")
          if [ -z "$DEPLOY_ID" ]; then
            echo "Frontend deploy start failed: no deploy id returned"
            exit 1
          fi
          echo "Frontend deploy id: $DEPLOY_ID"
          # Poll for status (max 30 attempts, 10s interval => ~5 minutes)
          for attempt in $(seq 1 30); do
            STATUS_JSON=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$DEPLOY_ID")
            echo "$STATUS_JSON" > /tmp/frontend_deploy_status.json
            STATUS=$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync('/tmp/frontend_deploy_status.json','utf8')); console.log((j.status||j.state||'').toLowerCase())")
            echo "Frontend deploy status: $STATUS"
            if echo "$STATUS" | grep -iq "fail\|error\|cancel"; then
              echo "Frontend deploy failed: $STATUS"
              cat /tmp/frontend_deploy_status.json
              exit 1
            fi
            if echo "$STATUS" | grep -Eiq "(succe|success|succeeded|live|active|ready|deployed|finished)"; then
              echo "Frontend deploy succeeded: $STATUS"
              break
            fi
            echo "Waiting 10s for frontend deploy to progress (attempt $attempt)..."
            sleep 10
          done
          if [ "$attempt" -eq 30 ]; then
            echo "Frontend deploy timed out"
            exit 1
          fi